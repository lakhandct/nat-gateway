name: CI

on:
  push:
    branches: [ main, feature/** ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read

jobs:
  lint-and-validate:
    name: Terraform + Ansible + Docs checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ---------- Terraform ----------
      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.5

      - name: Terraform fmt (check)
        working-directory: terraform
        run: terraform fmt -recursive -check

      - name: Terraform init (no backend)
        working-directory: terraform
        run: terraform init -backend=false

      - name: Terraform validate
        working-directory: terraform
        run: terraform validate -no-color

      # ---------- Ansible / YAML ----------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Ansible toolchain (pinned)
        run: |
          python -m pip install --upgrade pip
          pip install "ansible-core==2.19.3" "ansible-lint==24.*" "yamllint"
          ansible --version
          python -c "import ansible; print('ansible-core module:', ansible.__version__)"

      - name: Ansible Lint
        run: |
          ansible-lint -v ansible/site.yml ansible/roles/nat_ha

      - name: YAML lint (repo)
        run: |
          yamllint -s .

      # ---------- Markdown / links ----------
      - name: Link check (lychee)
        uses: lycheeverse/lychee-action@v1
        with:
          args: >-
            --verbose
            --no-progress
            --exclude-mail
            --accept 200,204,206,429
            --retry-wait-time 2
            --timeout 20
            --max-concurrency 5
            README.md docs/*.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
